stages:
  - build
  - test
  - lint
  - format-check

variables:
  GO_VERSION: "1.22"

before_script:
  - apt-get update && apt-get install -y curl
  - curl -LO https://go.dev/dl/go${GO_VERSION}.linux-amd64.tar.gz
  - tar -C /usr/local -xzf go${GO_VERSION}.linux-amd64.tar.gz
  - export PATH=$PATH:/usr/local/go/bin
  - go version

build:
  stage: build
  script:
    - go mod tidy
    - go build -v ./cmd/server

test:
  stage: test
  script:
    - go test -v ./...

lint:
  stage: lint
  script:
    - curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b $(go env GOPATH)/bin
    - golangci-lint run --out-format=colored-line-number

format-check:
  stage: format-check
  script:
    - if [ -n "$(gofmt -l .)" ]; then echo "Go code is not formatted correctly. Run 'gofmt -w .'"; exit 1; fi
